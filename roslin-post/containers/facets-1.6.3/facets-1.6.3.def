BootStrap: docker
From: ubuntu:18.04

%post
    export FACETS_SUITE_VERSION=1.6.3
    export FACETS_VERSION=0.5.14
    export PCTGCDATA=0.2.0

    apt-get update && \
    apt-get install -y \
    wget \
    bzip2 \
    make \
    gcc \
    g++ \
    gfortran \
    libxml2-dev \
    libcairo2-dev

    wget https://repo.continuum.io/miniconda/Miniconda3-4.4.10-Linux-x86_64.sh && \
    bash Miniconda3-4.4.10-Linux-x86_64.sh -b -p /conda && \
    rm -f Miniconda3-4.4.10-Linux-x86_64.sh

    export PATH="/conda/bin:${PATH}"

    conda config --add channels defaults
    conda config --add channels bioconda

    conda install -y \
    r::r-base=3.6.1 \
    r::r=3.6.0 \
    r::r-ggplot2=3.1.1 \
    r::r-cairo=1.5_10 \
    conda-forge::r-argparse=2.0.1 \
    r::r-data.table=1.12.2 \
    r::r-gtable=0.3.0 \
    r::r-gridextra=2.3 \
    conda-forge::r-bit64=0.9_7 \
    r::r-plyr=1.8.4 \
    conda-forge::r-formatr=1.7 \
    r::r-dplyr=0.8.0.1 \
    r::r-tidyr=0.8.3 \
    r::r-stringr=1.4.0 \
    r::r-reshape2=1.4.3 \
    bioconda::bioconductor-rtracklayer=1.46.0

    cd / && \
    wget https://github.com/mskcc/facets/archive/v${FACETS_VERSION}.tar.gz && \
    wget https://github.com/mskcc/pctGCdata/archive/v${PCTGCDATA}.tar.gz && \
    wget https://github.com/mskcc/facets-suite/archive/${FACETS_SUITE_VERSION}.tar.gz && \
    tar xvzf v${FACETS_VERSION}.tar.gz && \
    tar xvzf v${PCTGCDATA}.tar.gz && \
    tar xvzf ${FACETS_SUITE_VERSION}.tar.gz && \
    cd /pctGCdata-${PCTGCDATA} && \
    R CMD INSTALL . && \
    cd /facets-${FACETS_VERSION} && \
    R CMD INSTALL . && \
    cd /facets-suite-${FACETS_SUITE_VERSION} && \
    sed -i "s/# parser/parser/g" geneLevel.R && \
    sed -i "s/opt\/common\/CentOS_6-dev\/R\/R-3.2.2\//usr\//g" *.R && \
    sed -i "s/opt\/common\/CentOS_6-dev\/R\/R-3.4.1\//usr\//g" *.R && \
    sed -i "s/opt\/common\/CentOS_6-dev\/R\/R-3.1.3\//usr\//g" *.R && \
    sed -i "s/opt\/common\/CentOS_6-dev\/python\/python-2.7.10\/bin\/python/usr\/bin\/env python/g" facets && \
    sed -i "s/opt\/common\/CentOS_6-dev\/bin\/current\/python/usr\/bin\/env python/g" summarize_project.py

    mkdir -p /usr/bin/facets-suite/ && \
    mv /facets-suite-${FACETS_SUITE_VERSION}/* /usr/bin/facets-suite/

# %test
#     which R

%environment
    export FACETS_SUITE_VERSION=1.6.3
    export FACETS_VERSION=0.5.14
    export PCTGCDATA=0.2.0
    export PYTHONNOUSERSITE=set
    export FACETS_OVERRIDE_EXITCODE=set
    export PATH="/conda/bin:${PATH}"
    export LC_ALL="C.UTF-8"
    export LANG="C.UTF-8"
